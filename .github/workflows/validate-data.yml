name: Validate Data

on:
  pull_request:
    paths:
      - 'data/**'
      - 'schema.json'
      - 'api-aggregators-schema.json'
      - 'scripts/validate*.js'
      - '.github/workflows/validate-data.yml'
      - 'package.json'
  push:
    branches:
      - master
    paths:
      - 'data/**'
      - 'schema.json'
      - 'api-aggregators-schema.json'
      - 'scripts/validate*.js'
      - '.github/workflows/validate-data.yml'
      - 'package.json'

jobs:
  validate-changed-files:
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: 'npm'
      
      - name: üì• Install dependencies
        run: npm ci
      
      - name: üîç Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_PROVIDERS=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- 'data/account-providers/**/*.json' | tr '\n' ' ')
            CHANGED_AGGREGATORS=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- 'data/api-aggregators/**/*.json' | tr '\n' ' ')
            CHANGED_TPP=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- 'data/third-party-providers/**/*.json' | tr '\n' ' ')
          else
            CHANGED_PROVIDERS=$(git diff --name-only --diff-filter=ACMR HEAD~1 -- 'data/account-providers/**/*.json' | tr '\n' ' ')
            CHANGED_AGGREGATORS=$(git diff --name-only --diff-filter=ACMR HEAD~1 -- 'data/api-aggregators/**/*.json' | tr '\n' ' ')
            CHANGED_TPP=$(git diff --name-only --diff-filter=ACMR HEAD~1 -- 'data/third-party-providers/**/*.json' | tr '\n' ' ')
          fi
          
          ALL_CHANGED="$CHANGED_PROVIDERS $CHANGED_AGGREGATORS $CHANGED_TPP"
          ALL_CHANGED=$(echo "$ALL_CHANGED" | xargs)  # Trim whitespace
          
          echo "providers=$CHANGED_PROVIDERS" >> $GITHUB_OUTPUT
          echo "aggregators=$CHANGED_AGGREGATORS" >> $GITHUB_OUTPUT
          echo "tpp=$CHANGED_TPP" >> $GITHUB_OUTPUT
          echo "all=$ALL_CHANGED" >> $GITHUB_OUTPUT
          
          echo "üìÅ Changed providers: $CHANGED_PROVIDERS"
          echo "üìÅ Changed aggregators: $CHANGED_AGGREGATORS"
          echo "üìÅ Changed TPP: $CHANGED_TPP"
      
      - name: ‚ÑπÔ∏è No files to validate
        if: steps.changed-files.outputs.all == ''
        run: echo "No JSON files were changed"
      
      - name: üîç Validate changed provider files (schema)
        if: steps.changed-files.outputs.providers != ''
        run: |
          echo "Validating provider schema for changed files..."
          FAILED=0
          for file in ${{ steps.changed-files.outputs.providers }}; do
            if [ ! -f "$file" ]; then
              echo "‚ö†Ô∏è Skipping $file (file does not exist)"
              continue
            fi
            echo "  Validating: $file"
            if ! node scripts/validate-file.js "$file" --type=provider; then
              FAILED=1
            fi
          done
          if [ $FAILED -eq 1 ]; then
            exit 1
          fi
          echo "‚úÖ Provider schema validation passed"
      
      - name: üîç Validate changed aggregator files (schema)
        if: steps.changed-files.outputs.aggregators != ''
        run: |
          echo "Validating aggregator schema for changed files..."
          FAILED=0
          for file in ${{ steps.changed-files.outputs.aggregators }}; do
            if [ ! -f "$file" ]; then
              echo "‚ö†Ô∏è Skipping $file (file does not exist)"
              continue
            fi
            echo "  Validating: $file"
            if ! node scripts/validate-file.js "$file" --type=aggregator; then
              FAILED=1
            fi
          done
          if [ $FAILED -eq 1 ]; then
            exit 1
          fi
          echo "‚úÖ Aggregator schema validation passed"
      
      - name: üîç Validate changed TPP files (schema)
        if: steps.changed-files.outputs.tpp != ''
        run: |
          echo "Validating TPP schema for changed files..."
          FAILED=0
          for file in ${{ steps.changed-files.outputs.tpp }}; do
            if [ ! -f "$file" ]; then
              echo "‚ö†Ô∏è Skipping $file (file does not exist)"
              continue
            fi
            echo "  Validating: $file"
            if ! node scripts/validate-file.js "$file" --type=tpp; then
              FAILED=1
            fi
          done
          if [ $FAILED -eq 1 ]; then
            exit 1
          fi
          echo "‚úÖ TPP schema validation passed"
      
      - name: üñºÔ∏è Validate icons for changed files
        if: steps.changed-files.outputs.all != ''
        continue-on-error: true
        run: |
          node scripts/validate-icons.js ${{ steps.changed-files.outputs.all }} || echo "::warning::Some icon URLs are not accessible. Please ensure icons are uploaded."
      
      - name: üîç Check filename/ID mismatches
        if: steps.changed-files.outputs.all != ''
        run: |
          echo "Checking filename/ID consistency for changed files..."
          FAILED=0
          for file in ${{ steps.changed-files.outputs.all }}; do
            if [ ! -f "$file" ]; then
              continue
            fi
            FILENAME=$(basename "$file" .json)
            ID=$(node -e "console.log(require('./$file').id || '')")
            if [ -n "$ID" ] && [ "$FILENAME" != "$ID" ]; then
              echo "‚ùå Mismatch: $file (filename: $FILENAME, id: $ID)"
              FAILED=1
            fi
          done
          if [ $FAILED -eq 1 ]; then
            echo "::error::Filename/ID mismatches found. Filename must match the 'id' field in the JSON."
            exit 1
          fi
          echo "‚úÖ Filename/ID check passed"
      
      - name: ‚úÖ Validation passed
        if: success()
        run: echo "‚úÖ All validation checks passed for changed files!"

  pr-comment:
    runs-on: ubuntu-latest
    needs: [validate-changed-files]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: üìù Add PR comment on success
        if: needs.validate-changed-files.result == 'success'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ All validation checks passed for changed files!'
            })
      
      - name: üìù Add PR comment on failure
        if: needs.validate-changed-files.result == 'failure'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Validation failed!\n\nPlease review the errors in the workflow logs and ensure your data follows the required schema.'
            })
